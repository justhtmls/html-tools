<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" href="../../favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron 表达式生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .cron-display {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }

        .cron-expression {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: #98c379;
            word-break: break-all;
        }

        .cron-description {
            margin-top: 10px;
            color: #61afef;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .option-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .option-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .option-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .quick-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .preset-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .next-runs {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .next-runs h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .runs-list {
            list-style: none;
        }

        .runs-list li {
            padding: 8px 0;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
        }

        .runs-list li:last-child {
            border-bottom: none;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cron 表达式生成器</h1>
            <p>可视化和生成 Cron 定时任务表达式</p>
        </div>

        <div class="card">
            <div class="cron-display">
                <div class="cron-expression" id="cron-expression">* * * * *</div>
                <div class="cron-description" id="cron-description">每分钟执行一次</div>
            </div>

            <div class="quick-presets">
                <button class="preset-btn" onclick="setPreset('0 * * * *', '每小时')">每小时</button>
                <button class="preset-btn" onclick="setPreset('0 0 * * *', '每天')">每天</button>
                <button class="preset-btn" onclick="setPreset('0 0 * * 0', '每周')">每周</button>
                <button class="preset-btn" onclick="setPreset('0 0 1 * *', '每月')">每月</button>
                <button class="preset-btn" onclick="setPreset('0 0 * * 1-5', '工作日')">工作日</button>
                <button class="preset-btn" onclick="setPreset('*/5 * * * *', '每5分钟')">每5分钟</button>
            </div>

            <div class="options-grid">
                <div class="option-group">
                    <label>分钟</label>
                    <select id="minute" onchange="generate()">
                        <option value="*">*</option>
                        <option value="*/5">*/5 (每5分钟)</option>
                        <option value="*/15">*/15 (每15分钟)</option>
                        <option value="*/30">*/30 (每30分钟)</option>
                        <option value="0">0 (整点)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>小时</label>
                    <select id="hour" onchange="generate()">
                        <option value="*">*</option>
                        <option value="0">0 (午夜)</option>
                        <option value="6">6 (早上)</option>
                        <option value="9">9 (上午)</option>
                        <option value="12">12 (中午)</option>
                        <option value="18">18 (晚上)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>日期</label>
                    <select id="day" onchange="generate()">
                        <option value="*">*</option>
                        <option value="1">1 (月初)</option>
                        <option value="15">15 (月中)</option>
                        <option value="L">L (月末)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>月份</label>
                    <select id="month" onchange="generate()">
                        <option value="*">*</option>
                        <option value="1">1 (一月)</option>
                        <option value="4">4 (四月)</option>
                        <option value="7">7 (七月)</option>
                        <option value="10">10 (十月)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>星期</label>
                    <select id="weekday" onchange="generate()">
                        <option value="*">*</option>
                        <option value="0">0 (周日)</option>
                        <option value="1">1 (周一)</option>
                        <option value="1-5">1-5 (工作日)</option>
                        <option value="5">5 (周五)</option>
                        <option value="6">6 (周六)</option>
                    </select>
                </div>
            </div>

            <div class="next-runs">
                <h4>下次执行时间</h4>
                <ul class="runs-list" id="next-runs">
                    <li>每分钟执行一次</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function generate() {
            const minute = document.getElementById('minute').value;
            const hour = document.getElementById('hour').value;
            const day = document.getElementById('day').value;
            const month = document.getElementById('month').value;
            const weekday = document.getElementById('weekday').value;

            const cron = `${minute} ${hour} ${day} ${month} ${weekday}`;
            document.getElementById('cron-expression').textContent = cron;

            const description = describeCron(minute, hour, day, month, weekday);
            document.getElementById('cron-description').textContent = description;

            calculateNextRuns(cron);
        }

        function describeCron(minute, hour, day, month, weekday) {
            let desc = [];

            if (weekday === '1-5') {
                desc.push('每个工作日');
            } else if (weekday === '*') {
                // 每天
            } else if (weekday !== '*') {
                const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                desc.push(`每周${weekdays[parseInt(weekday)]}`);
            }

            if (month !== '*') {
                desc.push(`每月${month}月`);
            }

            if (day === 'L') {
                desc.push('月末');
            } else if (day !== '*') {
                desc.push(`每月${day}日`);
            }

            if (hour !== '*') {
                desc.push(`${hour}点`);
            }

            if (minute !== '*') {
                if (minute.startsWith('*/')) {
                    desc.push(`每${minute.slice(2)}分钟`);
                } else {
                    desc.push(`${minute}分`);
                }
            }

            if (desc.length === 0) return '每分钟执行一次';
            return desc.join('') + '执行';
        }

        function parseCronPart(part, min, max) {
            const values = new Set();

            if (part === '*') {
                for (let i = min; i <= max; i++) values.add(i);
                return values;
            }

            if (part.startsWith('*/')) {
                const step = parseInt(part.slice(2));
                for (let i = min; i <= max; i += step) values.add(i);
                return values;
            }

            if (part.includes('-')) {
                const [start, end] = part.split('-').map(Number);
                for (let i = start; i <= end; i++) values.add(i);
                return values;
            }

            values.add(parseInt(part));
            return values;
        }

        function getNextRun(cronParts, startDate) {
            const [minutePart, hourPart, dayPart, monthPart, weekdayPart] = cronParts;

            const minutes = minutePart === '*' ? null : parseCronPart(minutePart, 0, 59);
            const hours = hourPart === '*' ? null : parseCronPart(hourPart, 0, 23);
            const days = dayPart === '*' ? null : (dayPart === 'L' ? null : parseCronPart(dayPart, 1, 31));
            const months = monthPart === '*' ? null : parseCronPart(monthPart, 1, 12);
            const weekdays = weekdayPart === '*' ? null : parseCronPart(weekdayPart, 0, 6);

            let current = new Date(startDate);
            const startYear = current.getFullYear();
            const startMonth = current.getMonth();
            const startDay = current.getDate();
            const startHour = current.getHours();
            const startMin = current.getMinutes();

            current.setSeconds(0, 0);

            // 最多往前推2年
            for (let yearOffset = 0; yearOffset <= 2; yearOffset++) {
                const year = startYear + yearOffset;
                const monthStart = (yearOffset === 0) ? startMonth : 0;

                for (let month = monthStart; month < 12; month++) {
                    const monthNum = month + 1;

                    // 检查月份限制
                    if (months !== null && !months.has(monthNum)) {
                        continue;
                    }

                    // 获取该月天数
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const dayStart = (yearOffset === 0 && month === startMonth) ? startDay : 1;

                    for (let day = dayStart; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const weekday = date.getDay();

                        // 检查日期或星期限制（两者是OR关系，只要满足一个即可）
                        if (days !== null && !days.has(day)) {
                            // 如果指定了日期且当前日期不匹配，检查星期
                            if (weekdays === null || !weekdays.has(weekday)) {
                                continue;
                            }
                        }
                        if (weekdays !== null && !weekdays.has(weekday)) {
                            // 如果指定了星期且当前星期不匹配，检查日期
                            if (days === null || !days.has(day)) {
                                continue;
                            }
                        }
                        if (dayPart === 'L' && day !== daysInMonth) continue;

                        const hourStart = (yearOffset === 0 && month === startMonth && day === startDay) ? startHour : 0;

                        for (let hour = hourStart; hour < 24; hour++) {
                            // 检查小时限制
                            if (hours !== null && !hours.has(hour)) continue;

                            const minStart = (yearOffset === 0 && month === startMonth && day === startDay && hour === startHour) ? startMin + 1 : 0;

                            for (let min = minStart; min < 60; min++) {
                                // 检查分钟限制
                                if (minutes !== null && !minutes.has(min)) continue;

                                const nextRun = new Date(year, month, day, hour, min);
                                if (nextRun > startDate) {
                                    return nextRun;
                                }
                            }
                        }
                    }
                }
            }

            return null;
        }

        function calculateNextRuns(cron) {
            const parts = cron.split(' ');
            const runs = [];
            let current = new Date();

            for (let i = 0; i < 5; i++) {
                const next = getNextRun(parts, current);
                if (next) {
                    runs.push(next.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }));
                    current = next;
                } else {
                    break;
                }
            }

            document.getElementById('next-runs').innerHTML = runs.map(r => `<li>${r}</li>`).join('');
        }

        function setPreset(cron, description) {
            const parts = cron.split(' ');
            document.getElementById('minute').value = parts[0] === '*' ? '*' : (parts[0].includes('*/') ? parts[0] : '0');
            document.getElementById('hour').value = parts[1] === '*' ? '*' : parts[1];
            document.getElementById('day').value = parts[2] === '*' ? '*' : parts[2];
            document.getElementById('month').value = parts[3] === '*' ? '*' : parts[3];
            document.getElementById('weekday').value = parts[4] === '*' ? '*' : parts[4];

            document.getElementById('cron-expression').textContent = cron;
            document.getElementById('cron-description').textContent = description;

            calculateNextRuns(cron);
        }

        // Initialize
        generate();
    </script>
</body>
</html>
